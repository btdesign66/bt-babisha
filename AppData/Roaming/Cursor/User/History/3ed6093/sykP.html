<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navio - Route Optimization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6sNWP3otKrfEc5_YcCwwPVs_DaYZhKNc&libraries=places"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #3b82f6;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 320px;
            background-color: var(--card-background);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            left: 0;
            top: 0;
        }

        .sidebar.collapsed {
            transform: translateX(-320px);
        }

        .main-content {
            margin-left: 320px;
            transition: margin-left 0.3s ease;
            width: calc(100% - 320px);
        }

        .main-content.expanded {
            margin-left: 0;
            width: 100%;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-section h6 {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--background-color);
        }

        .map-container {
            flex: 1;
            position: relative;
            min-height: 500px;
        }

        /* Card Styles */
        .card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .card-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background-color: transparent;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Form Controls */
        .form-control, .form-select {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        /* Button Styles */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .map-control-group {
            background: var(--card-background);
            padding: 0.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 0.5rem;
        }

        .map-control-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            background: white;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .map-control-btn:hover {
            background-color: var(--background-color);
            transform: translateY(-1px);
        }

        .map-control-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .map-control-btn i {
            font-size: 1rem;
        }

        /* Search Bar */
        .search-container {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            z-index: 1000;
        }

        .search-box {
            background: var(--card-background);
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Route Summary */
        .route-summary {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            z-index: 1000;
        }

        .summary-card {
            background: var(--card-background);
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1rem;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background: var(--background-color);
        }

        .summary-item i {
            color: var(--primary-color);
        }

        /* Add new styles for point selection */
        .point-selection-mode {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            text-align: center;
        }

        .point-selection-mode.active {
            display: block;
        }

        .point-selection-mode i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .sidebar.expanded {
                /* transform: translateY(0); */
            }

            .main-content {
                margin-left: 0;
            }

            .map-controls {
                top: auto;
                bottom: 1rem;
            }
        }

        /* Suggestions Styles */
        .location-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h4 class="mb-0">Route Settings</h4>
                <button class="btn btn-link" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <!-- Route Preferences -->
                <div class="sidebar-section">
                    <h6>Route Preferences</h6>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="considerTraffic">
                        <label class="form-check-label" for="considerTraffic">Consider Traffic</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="avoidTolls">
                        <label class="form-check-label" for="avoidTolls">Avoid Tolls</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="useHighways">
                        <label class="form-check-label" for="useHighways">Use Highways</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="isRoundTrip">
                        <label class="form-check-label" for="isRoundTrip">Round Trip</label>
                    </div>
                </div>

                <!-- Optimization Priority -->
                <div class="sidebar-section">
                    <h6>Optimization Priority</h6>
                    <select class="form-select" id="priority">
                        <option value="distance">Distance</option>
                        <option value="time">Time</option>
                        <option value="balanced">Balanced</option>
                    </select>
                </div>

                <!-- Vehicle Settings -->
                <div class="sidebar-section">
                    <h6>Vehicle Settings</h6>
                    <select class="form-select mb-2" id="vehicleType">
                        <option value="car">Car</option>
                        <option value="truck">Truck</option>
                        <option value="van">Van</option>
                    </select>
                    <div class="input-group mb-2">
                        <span class="input-group-text">Fuel Efficiency</span>
                        <input type="number" class="form-control" id="fuelEfficiency" value="10">
                        <span class="input-group-text">km/L</span>
                    </div>
                </div>

                <!-- Location Inputs -->
                <div class="sidebar-section">
                    <h6>Route Details</h6>
                    <div class="mb-3">
                        <label class="form-label">Start Location</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="startLocation" placeholder="Enter start location">
                            <button class="btn btn-outline-primary" type="button" id="startLocationGPS" title="Use current location">
                                <i class="fas fa-location-arrow"></i>
                            </button>
                        </div>
                        <div id="startLocationSuggestions" class="location-suggestions"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Delivery Points</label>
                        <div id="waypointsList"></div>
                        <div class="input-group mt-2">
                            <input type="text" class="form-control" id="deliveryPointSearch" placeholder="Search delivery location">
                            <button class="btn btn-outline-primary" type="button" id="addDeliveryPointBtn">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div id="deliveryPointSuggestions" class="location-suggestions"></div>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="optimizeRoute()">
                            <i class="fas fa-route"></i> Optimize Route
                        </button>
                        <button class="btn btn-outline-danger" onclick="clearRoute()">
                            <i class="fas fa-trash"></i> Clear Route
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Map Container -->
            <div class="map-container" id="map">
                <!-- Search Bar -->
                <div class="search-container">
                    <div class="search-box">
                        <div class="input-group">
                            <input type="text" id="searchInput" class="form-control" placeholder="Search for a location...">
                            <button class="btn btn-primary" onclick="searchLocation()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div id="suggestions" class="location-suggestions"></div>
                </div>

                <!-- Map Controls -->
                <div class="map-controls">
                    <div class="map-control-group">
                        <button class="btn btn-primary map-control-btn" id="setStartPointBtn" title="Set start point">
                            <i class="fas fa-map-marker-alt"></i> Set Start
                        </button>
                        <button class="btn btn-primary map-control-btn" id="useCurrentLocationBtn" title="Use current location">
                            <i class="fas fa-location-arrow"></i> Current
                        </button>
                    </div>
                    <div class="map-control-group">
                        <button class="btn btn-primary map-control-btn" id="addDeliveryPointBtn" title="Add delivery point">
                            <i class="fas fa-plus"></i> Add Delivery
                        </button>
                        <button class="btn btn-danger map-control-btn" id="clearPointsBtn" title="Clear all points">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Route Summary -->
                <div class="route-summary">
                    <div class="summary-card">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="summary-item">
                                    <i class="fas fa-road"></i>
                                    <div>
                                        <small class="text-muted">Total Distance</small>
                                        <div><strong id="totalDistance">0</strong> km</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-item">
                                    <i class="fas fa-clock"></i>
                                    <div>
                                        <small class="text-muted">Estimated Time</small>
                                        <div><strong id="estimatedTime">0</strong> min</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-item">
                                    <i class="fas fa-gas-pump"></i>
                                    <div>
                                        <small class="text-muted">Fuel Cost</small>
                                        <div>$<strong id="fuelCost">0</strong></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Point Selection Mode -->
                <div class="point-selection-mode" id="pointSelectionMode">
                    <i class="fas fa-map-marker-alt"></i>
                    <p class="mb-0">Click on the map to add point</p>
                </div>
            </div>

            <!-- Directions Panel -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Turn-by-Turn Directions</h5>
                </div>
                <div class="card-body">
                    <div class="directions-list" id="directionsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let map;
        let markers = [];
        let directionsService;
        let directionsRenderer;
        let waypoints = [];
        let placeAutocomplete;
        let searchBox;
        let geocoder;
        let currentLocationMarker;
        let isSettingStartPoint = false;
        let isAddingDeliveryPoint = false;
        let startPointMarker = null;
        let pointInfoWindow = null;

        // Update the checkAuth function
        function checkAuth() {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            if (!token) {
                console.log('No token found');
                return false;
            }
            
            try {
                // Decode token to check expiration
                const payload = JSON.parse(atob(token.split('.')[1]));
                const expiry = payload.exp * 1000; // Convert to milliseconds
                
                if (Date.now() >= expiry) {
                    console.log('Token expired');
                    localStorage.removeItem('token');
                    sessionStorage.removeItem('token');
                    return false;
                }
                
                // Store user info if available
                if (payload.user_id) {
                    localStorage.setItem('user_id', payload.user_id);
                }
                
                return token;
            } catch (error) {
                console.error('Error checking token:', error);
                localStorage.removeItem('token');
                sessionStorage.removeItem('token');
                return false;
            }
        }

        // Add this function to handle login
        async function handleLogin(email, password) {
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    // Store token
                    localStorage.setItem('token', data.token);
                    
                    // Store user info
                    if (data.user) {
                        localStorage.setItem('user', JSON.stringify(data.user));
                    }
                    
                    return true;
                } else {
                    throw new Error(data.message || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                throw error;
            }
        }

        // Add this function to handle logout
        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('user_id');
            sessionStorage.removeItem('token');
            window.location.href = '/login';
        }

        // Update the handleAuthError function
        function handleAuthError() {
            const token = checkAuth();
            if (!token) {
                handleLogout();
                return false;
            }
            return true;
        }

        // Initialize map
        async function initializeMap() {
            console.log('Initializing map...');
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('Map element not found');
                return;
            }

            try {
                // Wait for Google Maps to load
                await new Promise(resolve => {
                    if (window.google && window.google.maps) {
                        resolve();
                    } else {
                        window.initMap = resolve;
                    }
                });

                map = new google.maps.Map(mapElement, {
                    center: { lat: 40.7128, lng: -74.0060 }, // New York City
                    zoom: 12,
                    mapTypeControl: true,
                    streetViewControl: true,
                    fullscreenControl: true,
                    zoomControl: true,
                    scaleControl: true
                });

                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: true
                });

                // Initialize geocoder
                geocoder = new google.maps.Geocoder();

                // Initialize point info window
                pointInfoWindow = new google.maps.InfoWindow({
                    content: '',
                    disableAutoPan: true
                });

                // Initialize map control buttons
                const setStartPointBtn = document.getElementById('setStartPointBtn');
                const useCurrentLocationBtn = document.getElementById('useCurrentLocationBtn');
                const addDeliveryPointBtn = document.getElementById('addDeliveryPointBtn');
                const clearPointsBtn = document.getElementById('clearPointsBtn');
                const pointSelectionMode = document.getElementById('pointSelectionMode');

                if (setStartPointBtn) {
                    setStartPointBtn.addEventListener('click', function() {
                        isSettingStartPoint = !isSettingStartPoint;
                        isAddingDeliveryPoint = false;
                        this.classList.toggle('active');
                        addDeliveryPointBtn.classList.remove('active');
                        pointSelectionMode.classList.toggle('active');
                        pointSelectionMode.querySelector('p').textContent = 'Click on the map to set start point';
                    });
                }

                if (useCurrentLocationBtn) {
                    useCurrentLocationBtn.addEventListener('click', function() {
                        getCurrentLocation();
                    });
                }

                if (addDeliveryPointBtn) {
                    addDeliveryPointBtn.addEventListener('click', function() {
                        isAddingDeliveryPoint = !isAddingDeliveryPoint;
                        isSettingStartPoint = false;
                        this.classList.toggle('active');
                        setStartPointBtn.classList.remove('active');
                        pointSelectionMode.classList.toggle('active');
                        pointSelectionMode.querySelector('p').textContent = 'Click on the map to add delivery point';
                    });
                }

                if (clearPointsBtn) {
                    clearPointsBtn.addEventListener('click', function() {
                        clearAllPoints();
                        pointSelectionMode.classList.remove('active');
                    });
                }

                // Add click listener to map
                map.addListener('click', function(event) {
                    if (isSettingStartPoint) {
                        setStartPoint(event.latLng);
                        isSettingStartPoint = false;
                        setStartPointBtn.classList.remove('active');
                        pointSelectionMode.classList.remove('active');
                    } else if (isAddingDeliveryPoint) {
                        addDeliveryPoint(event.latLng);
                    }
                });

                // Initialize search box
                const searchInput = document.getElementById('searchInput');
                searchBox = new google.maps.places.SearchBox(searchInput);

                searchBox.addListener('places_changed', function() {
                    const places = searchBox.getPlaces();
                    if (places.length === 0) return;

                    const place = places[0];
                    if (!place.geometry) return;

                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                    setStartPoint(place.geometry.location);
                });

                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Error initializing map:', error);
                alert('Failed to initialize map. Please refresh the page.');
            }
        }

        // Initialize sidebar toggle
        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const toggle = document.getElementById('sidebarToggle');

            // Set initial state based on screen size
            function updateSidebarState() {
                // Remove or comment out this block to keep sidebar always open
                // const isMobile = window.innerWidth <= 768;
                // if (isMobile) {
                //     sidebar.classList.add('collapsed');
                //     mainContent.classList.add('expanded');
                // } else {
                //     sidebar.classList.remove('collapsed');
                //     mainContent.classList.remove('expanded');
                // }
            }

            // Update on window resize
            window.addEventListener('resize', updateSidebarState);
            updateSidebarState();

            toggle.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                const isMobile = window.innerWidth <= 768;
                if (isMobile && !sidebar.contains(event.target) && !toggle.contains(event.target)) {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('expanded');
                }
            });
        }

        function showPointInfo(message) {
            if (pointInfoWindow) {
                pointInfoWindow.setContent(message);
                pointInfoWindow.setPosition(map.getCenter());
                pointInfoWindow.open(map);
            }
        }

        function hidePointInfo() {
            if (pointInfoWindow) {
                pointInfoWindow.close();
            }
        }

        function setStartPoint(latLng) {
            console.log('Setting start point:', latLng);
            
            if (!latLng) {
                console.error('Invalid location provided');
                return;
            }

            // Remove existing start point marker
            if (startPointMarker) {
                startPointMarker.setMap(null);
            }

            try {
                // Create new start point marker
                startPointMarker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    title: 'Start Point',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#4CAF50',
                        fillOpacity: 1,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2
                    },
                    label: {
                        text: 'S',
                        color: '#FFFFFF',
                        fontSize: '12px',
                        fontWeight: 'bold'
                    }
                });

                // Get address for the location
                geocoder.geocode({ location: latLng }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const address = results[0].formatted_address;
                        document.getElementById('startLocation').value = address;
                        startPointMarker.setTitle(address);
                        showPointInfo('Start point set: ' + address);
                    } else {
                        console.error('Geocoding failed:', status);
                        showPointInfo('Failed to get address for this location');
                    }
                });
            } catch (error) {
                console.error('Error setting start point:', error);
                showPointInfo('Error setting start point');
            }
        }

        function addDeliveryPoint(latLng) {
            console.log('Adding delivery point:', latLng);
            
            if (!latLng) {
                console.error('Invalid location provided');
                return;
            }

            if (waypoints.length >= 10) {
                alert('Maximum 10 delivery points allowed');
                return;
            }

            try {
                // Get address for the location
                geocoder.geocode({ location: latLng }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const address = results[0].formatted_address;
                        const index = waypoints.length + 1;
                        
                        // Create marker
                        const marker = new google.maps.Marker({
                            position: latLng,
                            map: map,
                            title: address,
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 8,
                                fillColor: '#FF0000',
                                fillOpacity: 1,
                                strokeColor: '#FFFFFF',
                                strokeWeight: 2
                            },
                            label: {
                                text: index.toString(),
                                color: '#FFFFFF',
                                fontSize: '12px',
                                fontWeight: 'bold'
                            }
                        });

                        // Add to waypoints list
                        const waypointDiv = document.createElement('div');
                        waypointDiv.className = 'input-group mb-2';
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'form-control';
                        input.value = address;
                        input.readOnly = true;
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'btn btn-outline-danger';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        removeBtn.onclick = function() {
                            const idx = waypoints.indexOf(waypointDiv);
                            if (idx > -1) {
                                waypoints.splice(idx, 1);
                                markers[idx].setMap(null);
                                markers.splice(idx, 1);
                                updateWaypointLabels();
                            }
                            waypointDiv.remove();
                        };
                        
                        waypointDiv.appendChild(input);
                        waypointDiv.appendChild(removeBtn);
                        document.getElementById('waypointsList').appendChild(waypointDiv);
                        
                        waypoints.push(waypointDiv);
                        markers.push(marker);
                        showPointInfo('Delivery point added: ' + address);
                    } else {
                        console.error('Geocoding failed:', status);
                        showPointInfo('Failed to get address for this location');
                    }
                });
            } catch (error) {
                console.error('Error adding delivery point:', error);
                showPointInfo('Error adding delivery point');
            }
        }

        function updateWaypointLabels() {
            markers.forEach((marker, index) => {
                marker.setLabel({
                    text: (index + 1).toString(),
                    color: '#FFFFFF',
                    fontSize: '12px',
                    fontWeight: 'bold'
                });
            });
        }

        function clearAllPoints() {
            // Clear start point
            if (startPointMarker) {
                startPointMarker.setMap(null);
                startPointMarker = null;
            }

            // Clear delivery points
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Clear waypoints list
            document.getElementById('waypointsList').innerHTML = '';
            waypoints = [];

            // Clear directions
            directionsRenderer.setDirections({ routes: [] });

            // Reset input fields
            document.getElementById('startLocation').value = '';

            // Reset buttons
            isSettingStartPoint = false;
            isAddingDeliveryPoint = false;
            document.getElementById('setStartPointBtn').classList.remove('active');
            document.getElementById('addDeliveryPointBtn').classList.remove('active');
            hidePointInfo();
        }

        // Update getCurrentLocation function
        function getCurrentLocation() {
            if (navigator.geolocation) {
                const locationButton = document.getElementById('useCurrentLocationBtn');
                locationButton.disabled = true;
                locationButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        map.setCenter(pos);
                        map.setZoom(15);
                        setStartPoint(pos);
                        
                        locationButton.disabled = false;
                        locationButton.innerHTML = '<i class="fas fa-location-arrow"></i> Current';
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        alert('Error getting your location. Please check your location settings.');
                        locationButton.disabled = false;
                        locationButton.innerHTML = '<i class="fas fa-location-arrow"></i> Current';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser.');
            }
        }

        // Search for location
        function searchLocation() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            
            if (!query) return;

            const service = new google.maps.places.PlacesService(map);
            const request = {
                query: query,
                fields: ['name', 'geometry', 'formatted_address']
            };

            service.textSearch(request, (results, status) => {
                const suggestionsDiv = document.getElementById('suggestions');
                suggestionsDiv.innerHTML = '';
                suggestionsDiv.style.display = 'none';

                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    results.forEach((place) => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = place.name;
                        div.addEventListener('click', () => {
                            map.setCenter(place.geometry.location);
                            map.setZoom(15);
                            
                            if (currentLocationMarker) {
                                currentLocationMarker.setMap(null);
                            }
                            currentLocationMarker = new google.maps.Marker({
                                map: map,
                                position: place.geometry.location,
                                title: place.name
                            });

                            document.getElementById('startLocation').value = place.formatted_address;

                            suggestionsDiv.style.display = 'none';
                            searchInput.value = '';
                        });
                        suggestionsDiv.appendChild(div);
                    });
                    suggestionsDiv.style.display = 'block';
                }
            });
        }

        // Add this before the window.onload function
        function initLocationSearch() {
            const startLocationInput = document.getElementById('startLocation');
            const deliveryPointSearch = document.getElementById('deliveryPointSearch');
            const startLocationGPS = document.getElementById('startLocationGPS');
            const startLocationSuggestions = document.getElementById('startLocationSuggestions');
            const deliveryPointSuggestions = document.getElementById('deliveryPointSuggestions');

            // Initialize Places Autocomplete for start location
            const startLocationAutocomplete = new google.maps.places.Autocomplete(startLocationInput, {
                types: ['geocode', 'establishment']
            });

            startLocationAutocomplete.addListener('place_changed', function() {
                const place = startLocationAutocomplete.getPlace();
                if (place.geometry) {
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                    setStartPoint(place.geometry.location);
                }
            });

            // Initialize Places Autocomplete for delivery points
            const deliveryPointAutocomplete = new google.maps.places.Autocomplete(deliveryPointSearch, {
                types: ['geocode', 'establishment']
            });

            deliveryPointAutocomplete.addListener('place_changed', function() {
                const place = deliveryPointAutocomplete.getPlace();
                if (place.geometry) {
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                    addDeliveryPoint(place.geometry.location);
                    deliveryPointSearch.value = ''; // Clear the input after adding
                }
            });

            // GPS button for start location
            startLocationGPS.addEventListener('click', function() {
                if (navigator.geolocation) {
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            map.setCenter(pos);
                            map.setZoom(15);
                            setStartPoint(pos);
                            
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-location-arrow"></i>';
                        },
                        (error) => {
                            console.error('Error getting location:', error);
                            alert('Error getting your location. Please check your location settings.');
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-location-arrow"></i>';
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                } else {
                    alert('Geolocation is not supported by your browser.');
                }
            });
        }

        // Update the optimizeRoute function
        async function optimizeRoute() {
            if (!handleAuthError()) return;

            const startLocation = document.getElementById('startLocation').value;
            if (!startLocation) {
                alert('Please enter a start location');
                return;
            }

            if (waypoints.length === 0) {
                alert('Please add at least one delivery point');
                return;
            }

            const waypointAddresses = waypoints.map(wp => wp.querySelector('input').value).filter(addr => addr);
            
            const preferences = {
                considerTraffic: document.getElementById('considerTraffic').checked,
                avoidTolls: document.getElementById('avoidTolls').checked,
                useHighways: document.getElementById('useHighways').checked,
                vehicleType: document.getElementById('vehicleType').value,
                fuelEfficiency: parseFloat(document.getElementById('fuelEfficiency').value)
            };

            try {
                // First, get coordinates for all locations
                const locations = await Promise.all([
                    getCoordinates(startLocation),
                    ...waypointAddresses.map(addr => getCoordinates(addr))
                ]);

                // Optimize the route
                const optimizedRoute = await optimizeWaypoints(locations[0], locations.slice(1));

                // Display the optimized route
                displayRoute({
                    startLocation: optimizedRoute[0],
                    waypoints: optimizedRoute.slice(1, -1),
                    endLocation: optimizedRoute[optimizedRoute.length - 1],
                    is_round_trip: document.getElementById('isRoundTrip').checked
                });

            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'Failed to optimize route. Please try again.');
            }
        }

        // Add new function to get coordinates from address
        async function getCoordinates(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ address: address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        resolve({
                            lat: results[0].geometry.location.lat(),
                            lng: results[0].geometry.location.lng()
                        });
                    } else {
                        reject(new Error(`Geocoding failed for address: ${address}`));
                    }
                });
            });
        }

        // Add new function to optimize waypoints
        async function optimizeWaypoints(start, waypoints) {
            // If there's only one waypoint, no need to optimize
            if (waypoints.length <= 1) {
                return [start, ...waypoints];
            }

            // Create a distance matrix
            const distanceMatrix = await calculateDistanceMatrix([start, ...waypoints]);

            // Use nearest neighbor algorithm for optimization
            const optimizedOrder = nearestNeighborOptimization(distanceMatrix);

            // Return the optimized route
            return optimizedOrder.map(index => index === 0 ? start : waypoints[index - 1]);
        }

        // Add function to calculate distance matrix
        async function calculateDistanceMatrix(locations) {
            const service = new google.maps.DistanceMatrixService();
            const origins = locations;
            const destinations = locations;

            return new Promise((resolve, reject) => {
                service.getDistanceMatrix({
                    origins: origins,
                    destinations: destinations,
                    travelMode: google.maps.TravelMode.DRIVING,
                    avoidHighways: document.getElementById('avoidTolls').checked,
                    avoidTolls: document.getElementById('avoidTolls').checked
                }, (response, status) => {
                    if (status === 'OK') {
                        const matrix = response.rows.map(row => 
                            row.elements.map(element => element.distance.value)
                        );
                        resolve(matrix);
                    } else {
                        reject(new Error('Failed to calculate distance matrix'));
                    }
                });
            });
        }

        // Add function to implement nearest neighbor algorithm
        function nearestNeighborOptimization(distanceMatrix) {
            const n = distanceMatrix.length;
            const visited = new Array(n).fill(false);
            const route = [0]; // Start with the first location
            visited[0] = true;

            while (route.length < n) {
                const current = route[route.length - 1];
                let minDistance = Infinity;
                let nextCity = -1;

                for (let i = 0; i < n; i++) {
                    if (!visited[i] && distanceMatrix[current][i] < minDistance) {
                        minDistance = distanceMatrix[current][i];
                        nextCity = i;
                    }
                }

                if (nextCity === -1) break;
                route.push(nextCity);
                visited[nextCity] = true;
            }

            // If it's a round trip, add the start point at the end
            if (document.getElementById('isRoundTrip').checked) {
                route.push(0);
            }

            return route;
        }

        // Display route on map
        function displayRoute(result) {
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Add start marker
            const startMarker = new google.maps.Marker({
                position: result.startLocation,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 10,
                    fillColor: '#4CAF50',
                    fillOpacity: 1,
                    strokeColor: '#FFFFFF',
                    strokeWeight: 2
                }
            });
            markers.push(startMarker);

            // Add waypoint markers
            result.waypoints.forEach((waypoint, index) => {
                const marker = new google.maps.Marker({
                    position: waypoint,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#FF0000',
                        fillOpacity: 1,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2
                    }
                });
                markers.push(marker);
            });

            // Add end marker if not round trip
            if (!result.is_round_trip) {
                const endMarker = new google.maps.Marker({
                    position: result.endLocation,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#F44336',
                        fillOpacity: 1,
                        strokeColor: '#FFFFFF',
                        strokeWeight: 2
                    }
                });
                markers.push(endMarker);
            }

            // Display route
            const request = {
                origin: result.startLocation,
                destination: result.is_round_trip ? result.startLocation : result.endLocation,
                waypoints: result.waypoints.map(location => ({
                    location: location,
                    stopover: true
                })),
                optimizeWaypoints: false,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, function(result, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    // Update summary
                    document.getElementById('totalDistance').textContent = 
                        (result.routes[0].legs.reduce((sum, leg) => sum + leg.distance.value, 0) / 1000).toFixed(1);
                    document.getElementById('estimatedTime').textContent = 
                        Math.round(result.routes[0].legs.reduce((sum, leg) => sum + leg.duration.value, 0) / 60);
                    
                    // Calculate fuel cost
                    const fuelEfficiency = parseFloat(document.getElementById('fuelEfficiency').value);
                    const fuelPrice = 1.5; // $ per liter
                    const fuelCost = (parseFloat(document.getElementById('totalDistance').textContent) / fuelEfficiency) * fuelPrice;
                    document.getElementById('fuelCost').textContent = fuelCost.toFixed(2);

                    // Display directions
                    const directionsList = document.getElementById('directionsList');
                    directionsList.innerHTML = '';
                    result.routes[0].legs.forEach((leg, index) => {
                        leg.steps.forEach(step => {
                            const stepDiv = document.createElement('div');
                            stepDiv.className = 'direction-step';
                            stepDiv.innerHTML = `
                                <div class="d-flex justify-content-between">
                                    <span>${step.instructions}</span>
                                    <small class="text-muted">${step.distance.text}</small>
                                </div>
                            `;
                            directionsList.appendChild(stepDiv);
                        });
                    });
                }
            });
        }

        // Clear route
        function clearRoute() {
            // Clear markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Clear start point marker
            if (startPointMarker) {
                startPointMarker.setMap(null);
                startPointMarker = null;
            }

            // Clear directions
            directionsRenderer.setDirections({ routes: [] });

            // Clear waypoints
            document.getElementById('waypointsList').innerHTML = '';
            waypoints = [];

            // Clear summary
            document.getElementById('totalDistance').textContent = '0';
            document.getElementById('estimatedTime').textContent = '0';
            document.getElementById('fuelCost').textContent = '0';
            document.getElementById('directionsList').innerHTML = '';

            // Reset map control buttons
            isSettingStartPoint = false;
            isAddingDeliveryPoint = false;
            document.getElementById('setStartPointBtn').classList.remove('active');
            document.getElementById('addDeliveryPointBtn').classList.remove('active');
            hidePointInfo();
        }

        // Update the window.onload function
        window.onload = function() {
            console.log('Page loaded, initializing...');
            
            // Check authentication first
            if (!handleAuthError()) return;
            
            // Initialize components
            initializeMap();
            initSidebar();
            initLocationSearch();
            
            // Add logout button event listener if it exists
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        };
    </script>
</body>
</html> 